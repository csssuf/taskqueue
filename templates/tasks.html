{% extends "base.html" %}
{% block tasksactive %}class="active"{% end %}
{% block content %}
<div class="panel panel-info">
	<div class="panel-heading">{{ conf['html']['tasktypeplural'] }}</div>
	<div class="panel-body">
		<p>This page auto-refreshes every {{ conf['websockets']['updatefreq'] }} seconds.
		<button class="btn btn-info btn-sm pull-right" id="manualrefresh">Refresh <span class="glyphicon glyphicon-refresh"></span></button></p>
	</div>
</div>
<div class="panel panel-primary">
	<div class="panel-heading">{{ conf['html']['tasktype'] }} List</div>
	<div class="panel-body">
		<p>{{ conf['html']['tldescription'] }}</p>
	</div>
	
	<table class="table table-hover">
		<thead>
			<tr>
				<th>#</th>
			{% for th in conf['tasks'] %}
				<th>{{ cf(th) }}</th>
			{% end %}
			</tr>
		</thead>
		<tbody>
			{% for i in range(len(tasks)) %}
			<tr id={{ i }}>
				<td>{{ i + 1 }}</td>
				{% for td in tasks[i] %}
				<td>{{ td }}</td>
				{% end %}
			</tr>
			{% end %}
		</tbody>
	</table>
<script>
	var ws = new WebSocket({{ "'" + conf['websockets']['address'] + "'" }});
	ws.onopen = function () {
		console.log('Websocket opened.');
		requestUpdate();
	};
	ws.onmessage = function(ev) {
		console.log("Message received: " + ev.data);
		onUpdate(ev.data);
	};
	ws.onclose = function(ev) {
		console.log("Websocket closed: " + ev.data);
	};
	ws.onerror = function(ev) {
		console.log("Websocket error:  " + ev.data);
	};
	function requestUpdate() {
		ws.send('update');
		setTimeout(requestUpdate, {{ conf['websockets']['updatefreq'] }}000);
	}
	function onUpdate(upd) {
		console.log("Update received: " + upd);
	}
	//yay jquery
	$('#manualrefresh').click(requestUpdate);
</script>
{% end %}
