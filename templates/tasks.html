{% extends "base.html" %}
{% block tasksactive %}class="active"{% end %}
{% block content %}
<div class="panel panel-info">
	<div class="panel-heading">{{ conf['html']['tasktypeplural'] }}</div>
	<div class="panel-body">
		<p>This page auto-refreshes every {{ conf['websockets']['updatefreq'] }} seconds.
		<button class="btn btn-info btn-sm pull-right" id="manualrefresh">Refresh <span class="glyphicon glyphicon-refresh"></span></button></p>
	</div>
</div>
<div class="panel panel-primary">
	<div class="panel-heading">{{ conf['html']['tasktype'] }} List</div>
	<div class="panel-body">
		<p>{{ conf['html']['tldescription'] }}</p>
	</div>
	
	<table class="table table-hover table-striped">
		<thead>
			<tr>
				<th>#</th>
			{% for th in conf['tasks'] %}<th>{{ cf(th) }}</th>{% end %}
			</tr>
		</thead>
		<tbody id="utable">
			{% for i in range(len(tasks)) %}
			<tr id={{ i }}>
				<td>{{ i + 1 }}</td>
				{% for td in tasks[i] %}<td>{{ td }}</td>{% end %}
			</tr>
			{% end %}
		</tbody>
	</table>
<script>
	var ws = new WebSocket({{ "'" + conf['websockets']['address'] + "'" }});
	ws.onopen = function () {
		console.log('Websocket opened.');
		//requestUpdate();
	};
	ws.onmessage = function(ev) {
		console.log("Message received: " + ev.data);
		var udd = JSON.parse(ev.data);
		$('#utable').fadeOut();
		setTimeout(function () { onUpdate(udd) }, 500);
		setTimeout(function () { $('#utable').fadeIn() }, 400);
	};
	ws.onclose = function(ev) {
		console.log("Websocket closed: " + ev.data);
	};
	ws.onerror = function(ev) {
		console.log("Websocket error:  " + ev.data);
	};
	function requestUpdate() {
		ws.send('update');
		setTimeout(requestUpdate, {{ conf['websockets']['updatefreq'] }}000);
	}
	function onUpdate(upd) {
		updateBadge(upd);
		bodyupdate = "";
		for(var i = 0; i < upd.length; i++) {
			bodyupdate += "<tr id=\"" + i + "\">\n";
			bodyupdate += "<td>" + (i + 1) + "</td>\n";
			for(var j = 0; j < upd[i].length; j++) {
				bodyupdate += "<td>" + upd[i][j] + "</td>\n";
			}
			bodyupdate += "</tr>\n";
		}
		$('#utable').html(bodyupdate);
	}
	$('#manualrefresh').click(requestUpdate);
</script>
{% end %}
